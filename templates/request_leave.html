{% extends "base.html" %}

{% block title %}Request Leave - Leave Tracker{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Request Leave</h1>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
      Back to calendar
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger py-2 small" role="alert">
      {{ error }}
    </div>
  {% endif %}
  {% if success %}
    <div class="alert alert-success py-2 small" role="alert">
      {{ success }}
    </div>
  {% endif %}

  {% if not employee %}
    <div class="card">
      <div class="card-body">
        <p class="mb-0 small text-muted">
          Your user account is not linked to an employee, so you cannot request leave.
          Please contact an administrator.
        </p>
      </div>
    </div>
  {% else %}

    <!-- Summary -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3">Your leave summary for {{ year }}</h2>

        <div class="lt-summary-cards mb-0">
          <!-- Leave Days -->
          <div class="lt-summary-card lt-summary-card-leave">
            <div class="lt-summary-card-main">
              <div class="lt-summary-circle">
                <div class="lt-summary-number">{{ entitlement | round(1) }}</div>
                <div class="lt-summary-label-small">DAYS</div>
              </div>
              <div class="lt-summary-title">Leave Days</div>
            </div>
          </div>

          <!-- Taken -->
          <div class="lt-summary-card lt-summary-card-taken">
            <div class="lt-summary-card-main">
              <div class="lt-summary-circle">
                <div class="lt-summary-number">{{ taken | round(1) }}</div>
                <div class="lt-summary-label-small">DAYS</div>
              </div>
              <div class="lt-summary-title">Taken</div>
            </div>
          </div>

          <!-- Remaining -->
          <div class="lt-summary-card lt-summary-card-remaining">
            <div class="lt-summary-card-main">
              <div class="lt-summary-circle">
                <div class="lt-summary-number">{{ remaining | round(1) }}</div>
                <div class="lt-summary-label-small">DAYS</div>
              </div>
              <div class="lt-summary-title">Remaining</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Request form -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">New leave request</h2>
        <p class="small text-muted mb-2">
          Add a range of dates or a single date, then optionally add more rows before submitting.
        </p>

        <form method="post" action="{{ url_for('request_leave') }}">
          <div id="date-rows">
            <div class="row g-2 mb-2 date-row">
              <div class="col-md-4">
                <label class="form-label form-label-sm">Start date</label>
                <input type="date"
                       class="form-control form-control-sm"
                       name="start_date"
                       required>
              </div>
              <div class="col-md-4">
                <label class="form-label form-label-sm">End date</label>
                <input type="date"
                       class="form-control form-control-sm"
                       name="end_date"
                       required>
              </div>
              <div class="col-md-3">
                <label class="form-label form-label-sm">Type</label>
                <select class="form-select form-select-sm"
                        name="code"
                        required>
                  <option value="">Select...</option>
                  <option value="F">Full-day leave</option>
                  <option value="H">Half-day leave</option>
                </select>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="button"
                        class="btn btn-outline-danger btn-sm w-100 remove-row-btn d-none">
                  &times;
                </button>
              </div>
            </div>
          </div>

          <button type="button"
                  class="btn btn-outline-secondary btn-sm mb-3"
                  id="add-range-btn">
            Add another date or range
          </button>

          <div class="mb-3">
            <label for="comment" class="form-label form-label-sm">
              Notes (optional)
            </label>
            <textarea class="form-control form-control-sm"
                      id="comment"
                      name="comment"
                      rows="2"
                      placeholder="Add any details for your manager..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-sm">
            Submit request
          </button>
        </form>
      </div>
    </div>

    <!-- Existing requests -->
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6 mb-3">Your requests</h2>
        {% if requests %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Dates</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Your note</th>
                  <th>Manager comment</th>
                  <th>Requested on</th>
                </tr>
              </thead>
              <tbody>
                {% for r in requests %}
                  <tr>
                    <td>
                      {{ r.start_date.strftime("%d %b %Y") }}
                      {% if r.end_date != r.start_date %}
                        &ndash; {{ r.end_date.strftime("%d %b %Y") }}
                      {% endif %}
                    </td>
                    <td>
                      {% if r.code == "F" %}
                        Full-day
                      {% elif r.code == "H" %}
                        Half-day
                      {% else %}
                        {{ r.code }}
                      {% endif %}
                    </td>
                    <td>
                      {% if r.status == "pending" %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% elif r.status == "approved" %}
                        <span class="badge bg-success">Approved</span>
                      {% elif r.status == "rejected" %}
                        <span class="badge bg-danger">Rejected</span>
                      {% elif r.status == "cancelled" %}
                        <span class="badge bg-secondary">Cancelled</span>
                      {% else %}
                        <span class="badge bg-light text-dark">{{ r.status }}</span>
                      {% endif %}
                    </td>
                    <td class="small">
                      {{ r.employee_comment or "" }}
                    </td>
                    <td class="small">
                      {{ r.manager_comment or "" }}
                    </td>
                    <td class="small text-muted">
                      {{ r.created_at.strftime("%d %b %Y") if r.created_at else "" }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small mb-0">
            You have not submitted any leave requests yet.
          </p>
        {% endif %}
      </div>
    </div>

  {% endif %}

</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      const container = document.getElementById('date-rows');
      const addBtn = document.getElementById('add-range-btn');

      // If elements not present, or already initialised, do nothing
      if (!container || !addBtn) return;
      if (container.dataset.initialised === '1') return;
      container.dataset.initialised = '1';

      function updateRemoveButtons() {
        const rows = container.querySelectorAll('.date-row');
        rows.forEach((row) => {
          const removeBtn = row.querySelector('.remove-row-btn');
          if (!removeBtn) return;
          if (rows.length === 1) {
            removeBtn.classList.add('d-none');
          } else {
            removeBtn.classList.remove('d-none');
          }
        });
      }

      addBtn.addEventListener('click', function() {
        const rows = container.querySelectorAll('.date-row');
        if (!rows.length) return;
        const last = rows[rows.length - 1];
        const clone = last.cloneNode(true);

        // Clear values in the cloned inputs/selects
        clone.querySelectorAll('input[type="date"]').forEach(function(el) {
          el.value = '';
        });
        clone.querySelectorAll('select').forEach(function(el) {
          el.value = '';
        });

        container.appendChild(clone);
        updateRemoveButtons();
      });

      container.addEventListener('click', function(evt) {
        if (evt.target.classList.contains('remove-row-btn')) {
          const row = evt.target.closest('.date-row');
          if (!row) return;
          row.remove();
          updateRemoveButtons();
        }
      });

      updateRemoveButtons();
    })();
  </script>
{% endblock %}
