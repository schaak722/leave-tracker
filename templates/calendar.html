{% extends "base.html" %}

{% block title %}Calendar - Leave Tracker{% endblock %}

{% block content %}

<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Calendar - {{ year }}</h1>
    <div>
      <a href="{{ url_for('index', year=year-1) }}" class="btn btn-outline-secondary btn-sm">&laquo; {{ year-1 }}</a>
      <a href="{{ url_for('index', year=year+1) }}" class="btn btn-outline-secondary btn-sm">{{ year+1 }} &raquo;</a>
    </div>
  </div>

  {# ============================================
     EMPLOYEE-ONLY SUMMARY CARDS (NEW)
     ============================================ #}
  {% if g.is_employee and g.user and g.user.employee %}
    {% set stats = per_employee.get(g.user.employee.id) %}
    {% if stats %}
      {% set ent = stats["entitlement"] %}
      {% set taken = stats["taken"] %}
      {% set remaining = stats["remaining"] %}

      <div class="lt-summary-cards mb-3">

        <!-- Leave Days -->
        <div class="lt-summary-card lt-summary-card-leave">
          <div class="lt-summary-card-main">
            <div class="lt-summary-circle">
              <div class="lt-summary-number">{{ "%.1f"|format(ent) }}</div>
              <div class="lt-summary-label-small">DAYS</div>
            </div>
            <div class="lt-summary-title">Leave Days</div>
          </div>
        </div>

        <!-- Taken -->
        <div class="lt-summary-card lt-summary-card-taken">
          <div class="lt-summary-card-main">
            <div class="lt-summary-circle">
              <div class="lt-summary-number">{{ "%.1f"|format(taken) }}</div>
              <div class="lt-summary-label-small">DAYS</div>
            </div>
            <div class="lt-summary-title">Taken</div>
          </div>
          <div class="lt-summary-actions">
            <a href="{{ url_for('employee_summary', employee_id=g.user.employee.id, year=year) }}"
               class="btn btn-outline-light btn-sm">View</a>
          </div>
        </div>

        <!-- Remaining -->
        <div class="lt-summary-card lt-summary-card-remaining">
          <div class="lt-summary-card-main">
            <div class="lt-summary-circle">
              <div class="lt-summary-number">{{ "%.1f"|format(remaining) }}</div>
              <div class="lt-summary-label-small">DAYS</div>
            </div>
            <div class="lt-summary-title">Remaining</div>
          </div>
          <div class="lt-summary-actions">
            <a href="{{ url_for('request_leave') }}"
               class="btn btn-outline-light btn-sm">Request leave</a>
          </div>
        </div>

      </div>
    {% endif %}
  {% endif %}


  {# ============================================
     ADMIN / MANAGER SUMMARY GRID (HIDDEN FROM EMPLOYEES)
     ============================================ #}
  {% if not g.is_employee %}
  <div class="card mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Summary</h2>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Entitlement</th>
              <th>Taken</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody>
            {% for employee in employees %}
              <tr>
                <td>{{ employee.name }}</td>
                td>{{ "%.1f"|format(per_employee[loop.index0]["entitlement"]) }}</td>
                <td>{{ "%.1f"|format(per_employee[loop.index0]["taken"]) }}</td>
                <td>{{ "%.1f"|format(per_employee[loop.index0]["remaining"]) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}


  {# ============================================
     CALENDAR TABLE
     ============================================ #}
  <div class="card">
    <div class="card-body table-responsive">
      <table class="table table-bordered calendar-table mb-0">
        <thead>
          <tr>
            <th class="calendar-header">Employee</th>
            {% for month_name, month_days in months %}
              <th class="calendar-header" colspan="{{ month_days|length }}">{{ month_name }}</th>
            {% endfor %}
          </tr>

          <tr>
            <th></th>
            {% for month_name, month_days in months %}
              {% for day in month_days %}
                <th class="calendar-day">{{ day.day }}</th>
              {% endfor %}
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for employee in employees %}
            <tr>
              <th class="employee-name">{{ employee.name }}</th>
              {% for month_name, month_days in months %}
                {% for day in month_days %}
                  {% set key = employee.id ~ "_" ~ day.isoformat() %}
                  {% set code = cell_codes.get(key) %}
                  <td class="calendar-cell
                             {% if code == 'F' %}cell-full{% endif %}
                             {% if code == 'H' %}cell-half{% endif %}
                             {% if day.weekday() >= 5 %}cell-weekend{% endif %}
                             {% if is_public_holiday(day) %}cell-holiday{% endif %}"
                      data-employee-id="{{ employee.id }}"
                      data-date="{{ day.isoformat() }}">
                    {{ code or "" }}
                  </td>
                {% endfor %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

</div>

{% endblock %}
