{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center mb-3 calendar-header">
  <div class="d-flex align-items-center">
    <div class="kmp-calendar-subtitle me-2">
      Leave Tracker
    </div>

    <div class="dropdown">
      <button class="btn btn-outline-primary btn-sm year-dropdown-toggle dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false">
        {{ year }}
      </button>
      <ul class="dropdown-menu year-dropdown-menu">
        {% for y in years %}
          <li>
            <a class="dropdown-item {% if y == year %}active{% endif %}"
               href="{{ url_for('calendar_view', year=y) }}">
              {{ y }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

{# ================================
   EMPLOYEE-ONLY SUMMARY CARDS
   ================================ #}
{% if g.is_employee and g.user and g.user.employee %}

  {# Find this employee's stats from per_employee (list of dicts) #}
  {% set ns = namespace(stats=None) %}
  {% for item in per_employee %}
    {% if item.employee.id == g.user.employee.id %}
      {% set ns.stats = item %}
    {% endif %}
  {% endfor %}

  {% if ns.stats %}
    {% set ent = ns.stats.entitlement %}
    {% set taken = ns.stats.taken %}
    {% set remaining = ns.stats.remaining %}

    <div class="lt-summary-cards mb-4">

      <!-- Leave Days -->
      <div class="lt-summary-card lt-summary-card-leave">
        <div class="lt-summary-card-main">
          <div class="lt-summary-circle">
            <div class="lt-summary-number">{{ ent | round(1) }}</div>
            <div class="lt-summary-label-small">DAYS</div>
          </div>
          <div class="lt-summary-title">Leave Days</div>
        </div>
      </div>

      <!-- Taken -->
      <div class="lt-summary-card lt-summary-card-taken">
        <div class="lt-summary-card-main">
          <div class="lt-summary-circle">
            <div class="lt-summary-number">{{ taken | round(1) }}</div>
            <div class="lt-summary-label-small">DAYS</div>
          </div>
          <div class="lt-summary-title">Taken</div>
        </div>
        <div class="lt-summary-actions">
          <a href="{{ url_for('employee_summary', employee_id=g.user.employee.id, year=year) }}"
             class="btn btn-outline-light btn-sm">
            View
          </a>
        </div>
      </div>

      <!-- Remaining -->
      <div class="lt-summary-card lt-summary-card-remaining">
        <div class="lt-summary-card-main">
          <div class="lt-summary-circle">
            <div class="lt-summary-number">{{ remaining | round(1) }}</div>
            <div class="lt-summary-label-small">DAYS</div>
          </div>
          <div class="lt-summary-title">Remaining</div>
        </div>
        <div class="lt-summary-actions">
          <a href="{{ url_for('request_leave') }}" class="btn btn-outline-light btn-sm">
            Request leave
          </a>
        </div>
      </div>

    </div>
  {% endif %}
{% endif %}

{# ================================
   SUMMARY TABLE (ADMINS/MANAGERS ONLY)
   ================================ #}
{% if not g.is_employee %}
<div class="mb-4 summary-wrapper">
  <h5>Summary</h5>
  <table class="table table-sm table-bordered summary-table w-auto">
    <thead class="table-light">
    <tr>
      <th>Employee</th>
      <th>Leave Days</th>
      <th>Taken</th>
      <th>Remaining</th>
      <th></th>
    </tr>
    </thead>
    <tbody>
    {% for item in per_employee %}
      <tr class="summary-row" data-employee-id="{{ item.employee.id }}">
        <td>{{ item.employee.name }}</td>
        <td class="summary-entitlement">{{ "%.1f"|format(item.entitlement) }}</td>
        <td class="summary-taken">{{ "%.1f"|format(item.taken) }}</td>
        <td class="summary-remaining">{{ "%.1f"|format(item.remaining) }}</td>
        <td>
          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('employee_summary',
                               employee_id=item.employee.id,
                               year=year) }}">
            View
          </a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Legend -->
<div class="calendar-legend card mb-4">
  <div class="card-body d-flex flex-wrap align-items-center gap-3">
    <div class="legend-item">
      <span class="legend-swatch legend-swatch-weekend"></span>
      <span>Weekend</span>
    </div>
    <div class="legend-item">
      <span class="legend-swatch legend-swatch-holiday"></span>
      <span>Public holiday</span>
    </div>
    <div class="legend-item">
      <span class="legend-swatch legend-swatch-birthday"></span>
      <span>Birthday</span>
    </div>
    <div class="legend-item">
      <span class="legend-badge legend-badge-f">F</span>
      <span>Full-day leave</span>
    </div>
    <div class="legend-item">
      <span class="legend-badge legend-badge-h">HM</span>
      <span>Half-day (Morning)</span>
    </div>
    <div class="legend-item">
      <span class="legend-badge legend-badge-h">HA</span>
      <span>Half-day (Afternoon)</span>
    </div>
  </div>
</div>

<!-- Monthly blocks -->
{% for m in month_data %}
  <div class="month-block">
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle mb-0 leave-table">
        <thead class="table-light">
        <!-- Month name + weekday letters row -->
        <tr class="weekday-header">
          <th class="month-name-cell">
            {{ m.month_name }}
          </th>
          {% for letter in m.weekday_letters %}
            {% set is_weekend = (letter == "S") %}
            <th class="text-center day-col {% if is_weekend %}weekend-col{% endif %}">
              {{ letter }}
            </th>
          {% endfor %}
        </tr>
        <!-- Day numbers row -->
        <tr class="day-number-header">
          <th></th>
          {% for day in m.days %}
            {% set letter = m.weekday_letters[loop.index0] %}
            {% set is_weekend = (letter == "S") %}
            <th class="text-center day-col {% if is_weekend %}weekend-col{% endif %}">
              {{ day }}
            </th>
          {% endfor %}
                </tr>
        </thead>
        <tbody>
        {% for emp in employees %}
          <tr>
            {# Employee name styling: only for employee view with a linked employee #}
            {% if g.is_employee and g.user and g.user.employee %}
              {% if g.user.employee.id == emp.id %}
                {% set name_class = "lt-emp-name-current" %}
              {% else %}
                {% set name_class = "lt-emp-name-other" %}
              {% endif %}
            {% else %}
              {% set name_class = "" %}
            {% endif %}

            <td class="{{ name_class }}">
              {{ emp.name }}
            </td>

            {% for day in m.days %}
              {% set date_str = "%04d-%02d-%02d"|format(year, m.month_number, day) %}
              {% set key = emp.id|string ~ "_" ~ date_str %}
              {% set code = cell_codes.get(key, "") %}
              {% set weekday_letter = m.weekday_letters[loop.index0] %}
              {% set is_weekend = (weekday_letter == "S") %}
              {% set is_holiday = date_str in public_holiday_dates %}
              {% set is_birthday = emp.birthday and
                                   emp.birthday.month == m.month_number and
                                   emp.birthday.day == day %}
              {% set locked = is_weekend or is_holiday %}
              <td class="leave-cell
                         {% if not (g.is_admin or g.is_manager) %} readonly{% endif %}
                         {% if is_weekend %} weekend-cell{% endif %}
                         {% if is_holiday %} holiday-cell{% endif %}
                         {% if is_birthday %} birthday-cell{% endif %}"
                  data-employee-id="{{ emp.id }}"
                  data-date="{{ date_str }}"
                  data-weekend="{{ 1 if is_weekend else 0 }}"
                  data-holiday="{{ 1 if is_holiday else 0 }}"
                  data-birthday="{{ 1 if is_birthday else 0 }}"
                  data-locked="{{ 1 if locked else 0 }}">
                {{ code }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const canEdit = {{ "true" if g.is_admin or g.is_manager else "false" }};
  const cells = document.querySelectorAll("td.leave-cell");
  
  function codeToValue(code) {
    if (code === "F") return 1.0;
    if (code === "H" || code === "HM" || code === "HA") return 0.5;
    return 0.0;
  }

  function updateSummary(empId, oldCode, newCode) {
    const row = document.querySelector(
      'tr.summary-row[data-employee-id="' + empId + '"]'
    );
    if (!row) return;

    const entCell = row.querySelector(".summary-entitlement");
    const takenCell = row.querySelector(".summary-taken");
    const remCell = row.querySelector(".summary-remaining");
    if (!entCell || !takenCell || !remCell) return;

    const entitlement = parseFloat(entCell.textContent) || 0.0;
    let taken = parseFloat(takenCell.textContent) || 0.0;

    const delta = codeToValue(newCode) - codeToValue(oldCode);
    taken = taken + delta;
    const remaining = entitlement - taken;

    takenCell.textContent = taken.toFixed(1);
    remCell.textContent = remaining.toFixed(1);
  }

  cells.forEach(cell => {
    const locked = cell.dataset.locked === "1";

    if (canEdit && !locked) {
      cell.style.cursor = "pointer";

      cell.addEventListener("click", function() {
        const empId = cell.dataset.employeeId;
        const dateStr = cell.dataset.date;
        const oldCode = (cell.textContent || "").trim();

    let newCode = "";
    if (oldCode === "") {
      newCode = "F";
    } else if (oldCode === "F") {
      newCode = "HM";
    } else if (oldCode === "HM") {
      newCode = "HA";
    } else if (oldCode === "HA") {
      newCode = "";
    } else if (oldCode === "H") {
      // Backwards compatibility for any old data still using "H"
      newCode = "HM";
    }


        fetch("{{ url_for('update_cell') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            employee_id: empId,
            date: dateStr,
            code: newCode
          })
        })
        .then(resp => resp.json().then(data => ({ ok: resp.ok, data })))
        .then(({ ok, data }) => {
          if (!ok || !data.success) {
            alert(data.error || "Error saving cell");
            return;
          }

          cell.textContent = newCode;
          updateSummary(empId, oldCode, newCode);
        })
        .catch(err => {
          console.error(err);
          alert("Network error saving cell");
        });
      });
    } else {
      cell.style.cursor = "default";
    }
  });
});
</script>
{% endblock %}
