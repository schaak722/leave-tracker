{% extends "base.html" %}
{% block title %}Manage Employees - Leave Tracker{% endblock %}

{% block content %}

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Manage Employees</h1>
  <div>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm me-2">
      Back to calendar
    </a>
      {% if show_archived %}
        <a href="{{ url_for('manage_employees') }}" class="btn btn-outline-secondary btn-sm me-2">
          View Active
        </a>
      {% else %}
        <a href="{{ url_for('manage_employees', show_archived=1) }}" class="btn btn-outline-secondary btn-sm me-2">
          View Archived
        </a>
      {% endif %}
    
    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createEmployeeModal">
      Create Employee
    </button>

    </div>
  </div>

  {% if employees %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Date of birth</th>
            <th scope="col">Active</th>
            <th scope="col">Reporting manager</th>
            <th scope="col" style="width: 30%;">Leave days (by year)</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for emp in employees %}
          <tr>
            <td>{{ emp.name }}</td>
            <td>
              {% if emp.birthday %}
                {{ emp.birthday.strftime('%d/%m/%y') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if emp.active %}
                <span class="badge bg-success">Yes</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td>
              {% if emp.reporting_manager %}
                {{ emp.reporting_manager.name }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if emp.entitlements %}
                {% for ent in emp.entitlements|sort(attribute="year") %}
                  <span class="me-2">
                    <strong>{{ ent.year }}</strong>:
                    {{ "%.1f"|format(ent.days) }}d
                  </span>
                {% endfor %}
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
            <td class="text-end">
              <a href="{{ url_for('edit_employee', employee_id=emp.id) }}"
                 class="btn btn-outline-primary btn-sm me-1">
                Edit
              </a>

            {% if not show_archived %}
              <form action="{{ url_for('archive_employee', employee_id=emp.id) }}"
                    method="post"
                    class="d-inline"
                    onsubmit="return confirm('Are you sure you want to archive this user?');">
                <button type="submit" class="btn btn-outline-warning btn-sm">
                  Archive
                </button>
              </form>
            {% else %}
              <form action="{{ url_for('restore_employee', employee_id=emp.id) }}"
                    method="post"
                    class="d-inline"
                    onsubmit="return confirm('Are you sure you want to restore this user?');">
                <button type="submit" class="btn btn-outline-success btn-sm">
                  Restore
                </button>
              </form>
            {% endif %}
              
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted mb-0">No employees found.</p>
  {% endif %}
</div>

<!-- Create Employee Modal -->
<div class="modal fade" id="createEmployeeModal" tabindex="-1" aria-labelledby="createEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createEmployeeModalLabel">Create Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" action="{{ url_for('create_employee_modal') }}">
        <div class="modal-body">

          <!-- Employee details -->
          <h6 class="mb-3">Employee details</h6>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="ce_first_name" class="form-label">First Name</label>
              <input type="text" class="form-control" id="ce_first_name" name="first_name" required>
            </div>
            <div class="col-md-6">
              <label for="ce_last_name" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="ce_last_name" name="last_name" required>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="ce_role" class="form-label">Role</label>
              <select class="form-select rounded-pill" id="ce_role" name="role" required>
                <option value="employee" selected>Employee</option>
                <option value="manager">Manager</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="ce_reporting_manager_id" class="form-label">Reporting Manager</label>
              <select class="form-select rounded-pill" id="ce_reporting_manager_id" name="reporting_manager_id">
                <option value="">-- None --</option>
                {% for m in manager_employees|sort(attribute="name") %}
                  <option value="{{ m.id }}">{{ m.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="ce_start_date" class="form-label">Start Date</label>
              <input type="date" class="form-control" id="ce_start_date" name="start_date">
            </div>
            <div class="col-md-6">
              <label for="ce_end_date" class="form-label">End Date</label>
              <input type="date" class="form-control" id="ce_end_date" name="end_date">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="ce_department" class="form-label">Department</label>
              <input type="text" class="form-control" id="ce_department" name="department">
            </div>
            <div class="col-md-6">
              <label for="ce_birthday" class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="ce_birthday" name="birthday">
            </div>
          </div>

          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="ce_active" name="active" checked>
            <label class="form-check-label" for="ce_active">Active</label>
          </div>

          <!-- Login details -->
          <h6 class="mb-3">Login details</h6>

          <div class="row g-3 mb-3">
            <div class="col-md-12">
              <label for="ce_email" class="form-label">Email (username)</label>
              <input type="email" class="form-control" id="ce_email" name="email" required>
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="ce_password" class="form-label">Password</label>
              <input type="password" class="form-control" id="ce_password" name="password" required autocomplete="new-password">
            </div>
            <div class="col-md-6">
              <label for="ce_confirm_password" class="form-label">Confirm Password</label>
              <input type="password" class="form-control" id="ce_confirm_password" name="confirm_password" required autocomplete="new-password">
            </div>
          </div>

          <!-- Leave days (below details to keep modal narrow) -->
          <h6 class="mb-3">Leave days</h6>

          <div class="alert alert-info d-none" id="ce_admin_leave_info">
            Admin users do not have leave days allocated.
          </div>

          <div id="ce_leave_days_block">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="ce_entitlement_year" class="form-label">Year</label>
                <input type="number" class="form-control" id="ce_entitlement_year" name="entitlement_year" value="{{ now().year if now is defined else '' }}">
              </div>
              <div class="col-md-6">
                <label for="ce_entitlement_days" class="form-label">Leave days</label>
                <input type="number" step="0.5" class="form-control" id="ce_entitlement_days" name="entitlement_days">
              </div>
            </div>
            <div class="form-text mt-1">
              Required for Employees and Managers.
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const roleSelect = document.getElementById("ce_role");
    const leaveBlock = document.getElementById("ce_leave_days_block");
    const adminInfo = document.getElementById("ce_admin_leave_info");

    function refreshLeaveDaysVisibility() {
      const role = (roleSelect.value || "").toLowerCase();
      if (role === "admin") {
        leaveBlock.classList.add("d-none");
        adminInfo.classList.remove("d-none");
      } else {
        leaveBlock.classList.remove("d-none");
        adminInfo.classList.add("d-none");
      }
    }

    if (roleSelect) {
      roleSelect.addEventListener("change", refreshLeaveDaysVisibility);
      refreshLeaveDaysVisibility();
    }
  });
</script>

{% endblock %}
