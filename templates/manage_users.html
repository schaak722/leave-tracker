{% extends "base.html" %}

{% block title %}Manage Users - Leave Tracker{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Manage Users</h1>
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
    Back to calendar
  </a>
</div>

{% if error %}
  <div class="alert alert-danger py-2 small" role="alert">
    {{ error }}
  </div>
{% endif %}

<div class="row">
  <div class="col-md-5 mb-3">
    <div class="card shadow-sm-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Create new user</h2>
        <form method="post" action="{{ url_for('create_user') }}">
          <div class="mb-2">
            <label class="form-label form-label-sm" for="username">Email (used as username)</label>
            <input type="text" name="username" id="username" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label form-label-sm" for="password">Password</label>
            <input type="password" name="password" id="password" class="form-control form-control-sm" required>
          </div>
          <div class="mb-2">
            <label class="form-label form-label-sm" for="role">Role</label>
            <select name="role" id="role" class="form-select form-select-sm">
              <option value="employee" selected>Employee</option>
              <option value="manager">Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label form-label-sm" for="employee_id">Linked employee (optional)</label>
            <select name="employee_id" id="employee_id" class="form-select form-select-sm">
              <option value="">-- None --</option>
              {% for e in employees %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">
            Create user
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-7 mb-3">
    <div class="card shadow-sm-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Existing users</h2>
        {% if users %}
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>Email (username)</th>
                  <th>Role</th>
                  <th>Active</th>
                  <th>Linked employee</th>
                  <th>New password</th>
                  <th style="width: 1%"></th>
                </tr>
              </thead>
              <tbody>
                {% for u in users %}
                  <tr>
                    <form method="post" action="{{ url_for('update_user', user_id=u.id) }}">
                      <td>
                        {{ u.username }}
                        {% if g.user and g.user.id == u.id %}
                          <span class="badge bg-secondary ms-1">You</span>
                        {% endif %}
                      </td>
                      <td>
                        <select name="role" class="form-select form-select-sm"
                                {% if g.user and g.user.id == u.id %}disabled{% endif %}>
                          <option value="employee" {% if u.role == "employee" or u.role == "user" %}selected{% endif %}>
                            Employee
                          </option>
                          <option value="manager" {% if u.role == "manager" %}selected{% endif %}>
                            Manager
                          </option>
                          <option value="admin" {% if u.role == "admin" %}selected{% endif %}>
                            Admin
                          </option>
                        </select>
                      </td>
                      <td class="text-center">
                        <input type="checkbox" name="active"
                               {% if u.active %}checked{% endif %}
                               {% if g.user and g.user.id == u.id %}disabled{% endif %}>
                      </td>
                      <td>
                        <select name="employee_id" class="form-select form-select-sm">
                          <option value="">-- None --</option>
                          {% for e in employees %}
                            <option value="{{ e.id }}"
                              {% if u.employee_id == e.id %}selected{% endif %}>
                              {{ e.name }}
                            </option>
                          {% endfor %}
                        </select>
                      </td>
                      <td>
                        <input type="password" name="password"
                               class="form-control form-control-sm"
                               placeholder="New password (optional)">
                      </td>
                      <td>
                        <button type="submit"
                                class="btn btn-outline-primary btn-sm">
                          Save
                        </button>
                      </td>
                    </form>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted small mb-0">No users found.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
