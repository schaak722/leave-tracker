{% extends "base.html" %}
{% block title %}Edit Employee - Leave Tracker{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Edit Employee</h1>
    <a href="{{ url_for('manage_employees') }}" class="btn btn-outline-secondary btn-sm">
      Back to employees
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
  {% endif %}

  <form method="post" class="mb-4">
    <div class="row g-4">
      <!-- LEFT: Employee details -->
      <div class="col-lg-6">
        <h2 class="h5 mb-3">Employee details</h2>

        <!-- Name -->
        <div class="mb-3">
          <label for="name" class="form-label">Name</label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-control"
            value="{{ employee.name }}"
            required
          >
        </div>

        <!-- Birthday (DD/MM/YY) -->
        <div class="mb-3">
          <label for="birthday" class="form-label">Birthday</label>
          <input
            type="text"
            id="birthday"
            name="birthday"
            class="form-control"
            placeholder="DD/MM/YY"
            value="{% if employee.birthday %}{{ employee.birthday.strftime('%d/%m/%y') }}{% endif %}"
          >
          <div class="form-text">
            Preferred format: DD/MM/YY (e.g., 22/07/78). Also accepted: DD/MM/YYYY or YYYY-MM-DD.
          </div>
        </div>

        <!-- Employment dates (DD/MM/YY) -->
        <div class="row g-3">
          <div class="col-md-6">
            <label for="start_date" class="form-label">Start date</label>
            <input
              type="text"
              id="start_date"
              name="start_date"
              class="form-control"
              placeholder="DD/MM/YY"
              value="{% if employee.start_date %}{{ employee.start_date.strftime('%d/%m/%y') }}{% endif %}"
            >
          </div>

          <div class="col-md-6">
            <label for="end_date" class="form-label">End date</label>
            <input
              type="text"
              id="end_date"
              name="end_date"
              class="form-control"
              placeholder="DD/MM/YY"
              value="{% if employee.end_date %}{{ employee.end_date.strftime('%d/%m/%y') }}{% endif %}"
            >
            <div class="form-text">
              Leave blank if the employee is still employed.
            </div>
          </div>
        </div>

        <!-- Reporting manager -->
        <div class="mb-3 mt-3">
          <label for="reporting_manager_id" class="form-label">Reporting manager</label>
          <select id="reporting_manager_id" name="reporting_manager_id" class="form-select">
            <option value="">-- None --</option>
            {% for m in manager_employees|sort(attribute="name") %}
              <option value="{{ m.id }}" {% if employee.reporting_manager_id == m.id %}selected{% endif %}>
                {{ m.name }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">
            This manager will receive email notifications for this employee’s leave requests.
          </div>
        </div>

        <!-- Active -->
        <div class="form-check mb-3">
          <input
            class="form-check-input"
            type="checkbox"
            id="active"
            name="active"
            {% if employee.active %}checked{% endif %}
          >
          <label class="form-check-label" for="active">
            Active
          </label>
        </div>

        <div class="text-muted small">
          Note: “Active” controls operational visibility. Calendar visibility is determined by Start/End dates.
        </div>
      </div>

      <!-- RIGHT: Leave days -->
      <div class="col-lg-6">
        <h2 class="h5 mb-3">Leave days</h2>
        <p class="text-muted mb-3">
          Set or update leave days for a specific year. If the year already exists, it will be updated.
        </p>

        <div class="row g-3 align-items-end">
          <div class="col-4">
            <label for="ent_year" class="form-label">Year</label>
            <input
              type="number"
              id="ent_year"
              name="ent_year"
              class="form-control"
              value="{{ current_year }}"
            >
          </div>

          <div class="col-4">
            <label for="ent_days" class="form-label">Leave days</label>
            <input
              type="number"
              step="0.5"
              id="ent_days"
              name="ent_days"
              class="form-control"
              value="{{ current_year_ent_days }}"
            >
          </div>

          <div class="col-4 text-end">
            <button type="submit" class="btn btn-primary">
              Save
            </button>
          </div>
        </div>

        <hr class="my-4">

        <h3 class="h6 mb-2">All leave days</h3>

        {% if employee.entitlements %}
          <ul class="list-unstyled mb-0">
            {% for ent in employee.entitlements|sort(attribute="year") %}
              <li class="d-flex align-items-center justify-content-between mb-2">
                <span>
                  <strong>{{ ent.year }}</strong>: {{ "%.1f"|format(ent.days) }} days
                </span>

                <form
                  action="{{ url_for('delete_entitlement', employee_id=employee.id, year=ent.year) }}"
                  method="post"
                  class="ms-2"
                  onsubmit="return confirm('Remove entitlement (and any leave entries) for {{ ent.year }}?');"
                >
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    Remove
                  </button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">No leave days defined.</p>
        {% endif %}
      </div>
    </div>
  </form>
</div>
{% endblock %}
