{% extends "base.html" %}
{% block title %}Edit Employee - Leave Tracker{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Edit Employee</h1>
    <a href="{{ url_for('manage_employees') }}" class="btn btn-outline-secondary btn-sm">
      Back to employees
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
  {% endif %}

  <div class="row g-4">

    <!-- LEFT: Employee details -->
    <div class="col-lg-6">
      <form method="post">
        <input type="hidden" name="form_action" value="employee_details">

        <h2 class="h5 mb-3">Employee details</h2>

        <!-- First Name / Last Name -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="first_name" class="form-label">First Name</label>
            <input
              type="text"
              id="first_name"
              name="first_name"
              class="form-control"
              value="{{ first_name_value }}"
              required
            >
          </div>

          <div class="col-md-6">
            <label for="last_name" class="form-label">Last Name</label>
            <input
              type="text"
              id="last_name"
              name="last_name"
              class="form-control"
              value="{{ last_name_value }}"
              required
            >
          </div>
        </div>

        <!-- Email (username) / Date of Birth -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="email" class="form-label">Email (username)</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              value="{{ username_value }}"
              placeholder="name@company.com"
            >
          </div>

          <div class="col-md-6">
            <label for="birthday" class="form-label">Date of Birth</label>
            <input
              type="date"
              id="birthday"
              name="birthday"
              class="form-control"
              value="{% if employee.birthday %}{{ employee.birthday.isoformat() }}{% endif %}"
            >
          </div>
        </div>

        <!-- Password / Confirm Password -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="password" class="form-label">Password</label>
           <input
            type="password"
            id="password"
            name="password"
            class="form-control"
            value=""
            autocomplete="new-password"
          >
          </div>

          <div class="col-md-6">
            <label for="confirm_password" class="form-label">Confirm Password</label>
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              class="form-control"
              value=""
              autocomplete="new-password"
            >
          </div>
        </div>

        <!-- Start Date / End Date -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="start_date" class="form-label">Start Date</label>
            <input
              type="date"
              id="start_date"
              name="start_date"
              class="form-control"
              value="{% if employee.start_date %}{{ employee.start_date.isoformat() }}{% endif %}"
            >
          </div>

          <div class="col-md-6">
            <label for="end_date" class="form-label">End Date</label>
            <input
              type="date"
              id="end_date"
              name="end_date"
              class="form-control"
              value="{% if employee.end_date %}{{ employee.end_date.isoformat() }}{% endif %}"
            >
          </div>
        </div>

        <!-- Role / Reporting Manager -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="role" class="form-label">Role</label>
            <select id="role" name="role" class="form-select rounded-pill">
              <option value="employee" {% if (employee.role or 'employee')|lower == 'employee' %}selected{% endif %}>Employee</option>
              <option value="manager" {% if (employee.role or '')|lower == 'manager' %}selected{% endif %}>Manager</option>
              <option value="admin" {% if (employee.role or '')|lower == 'admin' %}selected{% endif %}>Admin</option>
            </select>
          </div>

          <div class="col-md-6">
            <label for="reporting_manager_id" class="form-label">Reporting Manager</label>
            <select id="reporting_manager_id" name="reporting_manager_id" class="form-select rounded-pill">
              <option value="">-- None --</option>
              {% for m in manager_employees|sort(attribute="name") %}
                <option value="{{ m.id }}" {% if employee.reporting_manager_id == m.id %}selected{% endif %}>
                  {{ m.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Department (full width) -->
        <div class="mb-3">
          <label for="department" class="form-label">Department</label>
          <input
            type="text"
            id="department"
            name="department"
            class="form-control"
            value="{{ department_value }}"
          >
        </div>

        <!-- Active -->
        <div class="form-check mb-3">
          <input
            class="form-check-input"
            type="checkbox"
            id="active"
            name="active"
            {% if employee.active %}checked{% endif %}
          >
          <label class="form-check-label" for="active">
            Active
          </label>
        </div>

        <button type="submit" class="btn btn-primary">
          Save
        </button>
      </form>
    </div>

        <!-- RIGHT: Leave days -->
    <div class="col-lg-6">
      <h2 class="h5 mb-3">Leave days</h2>

      {% if (employee.role or 'employee')|lower != 'admin' %}

        <form method="post" class="mb-3">
        <input type="hidden" name="form_action" value="add_entitlement">
        <input type="hidden" name="is_edit_mode" value="{% if is_edit_mode %}1{% else %}0{% endif %}">
      
        <div class="row g-3">
          <div class="col-md-4">
            <label for="entitlement_year" class="form-label">Year</label>
            <input
              type="number"
              id="entitlement_year"
              name="entitlement_year"
              class="form-control"
              value="{{ entitlement_year_value }}"
              min="2000"
              max="2100"
              {% if is_edit_mode %}readonly{% endif %}
              required
            >
          </div>
      
          <div class="col-md-4">
            <label for="entitlement_days" class="form-label">Leave days</label>
            <input
              type="number"
              step="0.5"
              id="entitlement_days"
              name="entitlement_days"
              class="form-control"
              value="{{ entitlement_days_value }}"
              required
            >
          </div>
      
          <div class="col-md-4 d-flex align-items-end">
            {% if is_edit_mode %}
              <button type="submit" class="btn btn-primary w-100">Save</button>
            {% else %}
              <button type="submit" class="btn btn-primary w-100">Add</button>
            {% endif %}
          </div>
        </div>
      
        {% if is_edit_mode %}
          <div class="mt-2">
            <a href="{{ url_for('edit_employee', employee_id=employee.id) }}" class="btn btn-link p-0">
              Cancel edit
            </a>
          </div>
        {% endif %}
      </form>

        <div class="card">
          <div class="card-body">
            <h3 class="h6 mb-3">Existing leave days</h3>

            {% if employee.entitlements %}
              <ul class="list-group">
                {% for ent in employee.entitlements|sort(attribute="year", reverse=True) %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <strong>{{ ent.year }}</strong> - {{ ent.days }} days
                    </div>

                    <div class="d-flex gap-2">

                    <!-- Edit (pencil) -->
                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm"
                      title="Edit"
                      aria-label="Edit"
                      data-bs-toggle="modal"
                      data-bs-target="#editEntitlementModal"
                      data-year="{{ ent.year }}"
                      data-days="{{ ent.days }}"
                    >
                      <!-- pencil icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zM11.207 2L3 10.207V11h.793L12 2.793 11.207 2z"/>
                        <path d="M2.5 13.5l3.5-1.4L3.9 10 2.5 13.5z"/>
                      </svg>
                    </button>
                      
                    <!-- Delete (bin) -->
                    <form method="post" action="{{ url_for('delete_entitlement', employee_id=employee.id, year=ent.year) }}" class="mb-0 entitlement-delete-form">
                    <button
                      type="button"
                      class="btn btn-outline-danger btn-sm"
                      title="Delete"
                      aria-label="Delete"
                      data-bs-toggle="modal"
                      data-bs-target="#confirmDeleteEntitlementModal"
                      data-delete-action="{{ url_for('delete_entitlement', employee_id=employee.id, year=ent.year) }}"
                    >
                    <!-- bin icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0A.5.5 0 0 1 8.5 6v7a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0V6z"/>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13l-1 11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2L3 4h-.5a1 1 0 0 1 0-2H5.5l1-1h3l1 1h3a1 1 0 0 1 1 1zM4.118 4 5 14.5A1 1 0 0 0 6 15h4a1 1 0 0 0 1-.5L11.882 4H4.118z"/>
                    </svg>
                  </button>
                </form>

                  </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">No leave days defined.</p>
            {% endif %}
          </div>
        </div>

      {% else %}
        <div class="alert alert-info">
          Admin users do not have leave days allocated.
        </div>
      {% endif %}
    </div>
  </div>
</div>
        <!-- Edit Entitlement Modal -->
        <div class="modal fade" id="editEntitlementModal" tabindex="-1" aria-labelledby="editEntitlementModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editEntitlementModalLabel">Edit leave days</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
        
              <form method="post" id="editEntitlementForm">
                <input type="hidden" name="form_action" value="add_entitlement">
                <input type="hidden" name="is_edit_mode" value="1">
        
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="modal_entitlement_year" class="form-label">Year</label>
                    <input type="number" id="modal_entitlement_year" name="entitlement_year" class="form-control" readonly>
                  </div>
        
                  <div class="mb-3">
                    <label for="modal_entitlement_days" class="form-label">Leave days</label>
                    <input type="number" step="0.5" id="modal_entitlement_days" name="entitlement_days" class="form-control" required>
                  </div>
                </div>
        
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            // -----------------------------
            // A) Edit entitlement modal
            // -----------------------------
            const editModal = document.getElementById("editEntitlementModal");
            if (editModal) {
              editModal.addEventListener("show.bs.modal", function (event) {
                const button = event.relatedTarget;
                if (!button) return;
        
                const year = button.getAttribute("data-year");
                const days = button.getAttribute("data-days");
        
                const yearInput = document.getElementById("modal_entitlement_year");
                const daysInput = document.getElementById("modal_entitlement_days");
        
                if (yearInput) yearInput.value = year || "";
                if (daysInput) daysInput.value = days || "";
              });
            }
        
            // -----------------------------
            // B) Confirm delete modal
            // -----------------------------
            const deleteModal = document.getElementById("confirmDeleteEntitlementModal");
            const confirmDeleteForm = document.getElementById("confirmDeleteEntitlementForm");
        
            if (deleteModal && confirmDeleteForm) {
              deleteModal.addEventListener("show.bs.modal", function (event) {
                const button = event.relatedTarget;
                if (!button) return;
        
                const action = button.getAttribute("data-delete-action");
                if (action) {
                  confirmDeleteForm.setAttribute("action", action);
                }
              });
            }
          });
        </script>
          
        <!-- Confirm Delete Modal -->
          <div class="modal fade" id="confirmDeleteEntitlementModal" tabindex="-1" aria-labelledby="confirmDeleteEntitlementModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="confirmDeleteEntitlementModalLabel">Confirm deletion</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
          
                <div class="modal-body">
                  Are you sure you want to delete these leave days? This will also delete any leave entries for that year.
                </div>
          
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          
                  <form method="post" id="confirmDeleteEntitlementForm">
                    <button type="submit" class="btn btn-danger">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

{% endblock %}
